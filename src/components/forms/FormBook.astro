---
const message = Astro.url.searchParams.get('message');
const decodedMessage = message ? decodeURIComponent(message.replace(/\+/g, ' ')) : '';
---

<form action="https://api.web3forms.com/submit" method="POST">
  <input type="hidden" name="access_key" value="ea3a8db2-5722-43ce-a6d3-8fff73904449">
  
  <div class="flex flex-col gap-8 mx-auto max-w-md">
    <div>
      <label for="name">Jméno a příjmení</label>
      <div class="mt-2">
        <input type="text" name="name" id="name" required />
      </div>
    </div>

    <div>
      <label for="email">E-mail</label>
      <div class="mt-2 grid grid-cols-1">
        <input type="email" name="email" id="email" required />
      </div>
    </div>

    <div>
      <label for="phone">Telefon</label>
      <div class="mt-2">
        <input type="text" name="phone" id="phone" required />
      </div>
      <small class="italic text-gray-500">Zavoláme vám pro potvrzení rezervace</small>
    </div>

    <div>
      <label for="message">Co přesně si přejete zhotovit</label>
      <div class="mt-2">
        <textarea
          name="message"
          id="message"
          rows="4"
          required
          placeholder="Uveďte zde veškeré detaily a požadavky"
        >{decodedMessage}</textarea>
      </div>
    </div>

    <div>
      <button type="submit" class="button button-green group !px-8">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-5 -rotate-45 -mt-1 inline-block mr-1 group-hover:rotate-0 transition duration-300"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"
          ></path>
        </svg>
        Odeslat
      </button>
    </div>
  </div>
</form>

<script is:inline>
  !function(){
    var appUrl = "https://app.formbricks.com";
    var environmentId = "cmfi9tpcq1wroy501o68x1u57";
    var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=appUrl+"/js/formbricks.umd.cjs",t.onload=function(){window.formbricks?window.formbricks.setup({environmentId:environmentId,appUrl:appUrl}):console.error("Formbricks library failed to load properly. The formbricks object is not available.");};
    var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e);
  }();
</script>
<script is:inline>
  function fillMessageFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    console.log('urlParams :>> ', urlParams);
    const message = urlParams.get('message');
    console.log('message :>> ', message);
    
    if (message) {
      const messageField = document.getElementById('message');
      if (messageField && !messageField.value) { // Only fill if empty
        messageField.value = decodeURIComponent(message);
        console.log('Message field filled with:', messageField.value);
      }
    }
  }
  
  // Function to ensure DOM is ready
  function whenReady(fn) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      fn();
    }
  }
  
  // Run when DOM is ready
  whenReady(fillMessageFromURL);
  
  // Set up observer for dynamic content
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList') {
        const messageField = document.getElementById('message');
        if (messageField && !messageField.value) {
          fillMessageFromURL();
        }
      }
    });
  });
  
  // Start observing
  whenReady(function() {
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  });
  
  // Also listen for navigation events
  window.addEventListener('popstate', () => setTimeout(fillMessageFromURL, 100));
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      setTimeout(fillMessageFromURL, 100);
    }
  });
</script>
